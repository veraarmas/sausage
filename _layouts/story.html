<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% if page.title %}{{ page.title }} | {% endif %}{{ site.title }}</title>

  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Load language data with fallback to English -->
  {% if site.telar_language and site.data.languages[site.telar_language] %}
    {% assign lang = site.data.languages[site.telar_language] %}
  {% else %}
    {% assign lang = site.data.languages['en'] %}
  {% endif %}

  <!-- Check if Christmas Tree Mode is enabled in config -->
  {% assign is_christmas_tree_mode = false %}
  {% if site.development-features.christmas_tree_mode %}
    {% assign is_christmas_tree_mode = true %}
  {% endif %}

  <!-- Check if step indicators should be shown -->
  {% assign show_story_steps = true %}
  {% if site.story_interface.show_story_steps == false %}
    {% assign show_story_steps = false %}
  {% endif %}

  <!-- Check if story is encrypted (protected) -->
  {% assign is_encrypted = false %}
  {% if page.data_file %}
    {% assign data_file_name = page.data_file %}
    {% assign story_json = site.data[data_file_name] %}
    {% if story_json.encrypted %}
      {% assign is_encrypted = true %}
    {% endif %}
  {% endif %}

  <script>
  // Expose Christmas Tree Mode to JavaScript
  window.christmasTreeMode = {{ is_christmas_tree_mode }};

  // Expose language strings to JavaScript
  window.telarLang = {
    goDeeper: "{{ lang.buttons.go_deeper }}",
    stepNumber: "{{ lang.story.step_number }}",
    demoPanelBadge: "{{ lang.demo.panel_badge }}",
    creditPrefix: "{{ lang.object.credit_prefix }}",
    embedBanner: {
      text: {{ lang.embed_banner.text | jsonify }},
      link: "{{ lang.embed_banner.link }}"
    }
  };

  // Expose config options to JavaScript
  window.telarConfig = {
    showObjectCredits: {{ site.story_interface.show_object_credits | default: false }},
    viewer_preloading: {
      max_viewer_cards: {{ site.development-features.viewer_preloading.max_viewer_cards | default: 10 }},
      preload_steps: {{ site.development-features.viewer_preloading.preload_steps | default: 6 }},
      loading_threshold: {{ site.development-features.viewer_preloading.loading_threshold | default: 5 }},
      min_ready_viewers: {{ site.development-features.viewer_preloading.min_ready_viewers | default: 3 }}
    }
  };

  // If Christmas Tree Mode is active, add üéÑ to all warning headings
  if (window.christmasTreeMode) {
    document.addEventListener('DOMContentLoaded', function() {
      document.querySelectorAll('.alert strong').forEach(function(heading) {
        if (!heading.textContent.includes('üéÑ')) {
          heading.textContent = 'üéÑ ' + heading.textContent;
        }
      });
    });
  }
  </script>

  <!-- Google Fonts - Dynamic based on theme -->
  {% assign theme = site.data.themes[site.telar_theme] %}
  {% assign heading_font = theme.fonts.headings | remove: "'" | split: ',' | first | strip %}
  {% assign body_font = theme.fonts.body | remove: "'" | split: ',' | first | strip %}
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family={{ heading_font | replace: ' ', '+' }}:wght@400;700&family={{ body_font | replace: ' ', '+' }}:wght@300;400;600;700&display=swap" rel="stylesheet">

  <!-- Material Symbols for home icon -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0">

  <!-- Embed Mode Detection (must load early) -->
  <script src="{{ '/assets/js/embed.js' | relative_url }}"></script>

  <!-- Custom CSS -->
  <link rel="stylesheet" href="{{ '/assets/css/telar.css' | relative_url }}?v={{ site.telar.version }}">

  {% seo %}
</head>
<body class="story-page">
  <!-- Fixed Back to Home Button (hidden in embed mode) -->
  <nav aria-label="Site navigation">
    <a href="{{ '/' | relative_url }}" class="btn-home">
      <span class="material-symbols-outlined btn-home-icon">home</span>
      <span class="btn-home-text">{{ lang.buttons.back_to_home }}</span>
    </a>
  </nav>

  <!-- Fixed Share Button (hidden in embed mode, floats on right) -->
  {% include share-button.html variant="icon-text" context="story" %}

  <main class="story-container">
    <!-- Left Column: Card Stacking Narrative -->
    <div class="narrative-column">
      <!-- Story Steps (including intro as step 0) -->
      <div class="story-steps">
        <!-- Intro Step - Full screen title card -->
        <div class="story-step story-intro" data-step="0" data-step-index="0">
          <div class="intro-content">
            {% if page.demo %}
            <p class="intro-demo-label">{{ lang.story.demo_label }}</p>
            {% else %}
            <h1 class="intro-title">{{ page.story_number }}.</h1>
            {% endif %}
            <h1 class="intro-title">{{ page.title }}</h1>
            {% if page.subtitle %}
            <h2 class="intro-subtitle">{{ page.subtitle }}</h2>
            {% endif %}
            {% if page.byline %}
            <h3 class="intro-byline">{{ page.byline | markdownify | remove: '<p>' | remove: '</p>' }}</h3>
            {% endif %}

            {% if page.description %}
            <p class="intro-description">{{ page.description }}</p>
            {% endif %}

            {% if page.data_file %}
              {% assign data_file_name = page.data_file %}
              {% assign steps = site.data[data_file_name] %}
              {% if steps.size > 0 and steps[0]._metadata %}
                {% assign metadata = steps[0] %}
                {% if metadata.viewer_warnings.size > 0 %}
                  <div class="alert alert-warning telar-alert mt-4" role="alert" style="text-align: left;">
                    <strong>‚ö†Ô∏è {{ lang.story.config_issues_heading }}</strong>
                    <p class="mb-2 mt-2">{{ lang.story.config_issues_heading }}</p>
                    <ul class="mb-2">
                    {% for warning in metadata.viewer_warnings %}
                      <li>
                        {% assign step_text = lang.story.step_number | replace: "{{ number }}", warning.step %}
                        <strong>{{ step_text }}</strong>
                        {% if warning.type == 'viewer' %}
                          {{ lang.story.viewer_error_prefix }} {{ warning.message | markdownify | remove: '<p>' | remove: '</p>' | strip }}
                        {% elsif warning.type == 'panel' %}
                          {{ warning.message | markdownify | remove: '<p>' | remove: '</p>' | strip }}
                        {% elsif warning.type == 'glossary' %}
                          {{ lang.story.glossary_error_prefix }} {{ warning.message | markdownify | remove: '<p>' | remove: '</p>' | strip }}
                        {% endif %}
                      </li>
                    {% endfor %}
                    </ul>
                    <p class="mb-0">{{ lang.story.preview_warning }}</p>
                  </div>
                {% endif %}
              {% endif %}
            {% endif %}

            <div class="intro-hint">
              <p class="text-muted">
                <small class="hint-desktop">{{ lang.story.scroll_hint }}</small>
                <small class="hint-mobile">{{ lang.story.scroll_hint_mobile }}</small>
              </p>
            </div>
          </div>
        </div>
        {% if page.data_file %}
          {% assign data_file_name = page.data_file %}
          {% assign steps = site.data[data_file_name] %}
          {% if is_encrypted %}
            <!-- Steps will be rendered by JavaScript after decryption -->
            <div id="encrypted-steps-container"></div>
          {% else %}
            {% for step in steps %}
              {% unless step._metadata %}
                {% include story-step.html
                  step_number=step.step
                  question=step.question
                  answer=step.answer
                  object_id=step.object
                  x=step.x
                  y=step.y
                  zoom=step.zoom
                  layer1button=step.layer1_button
                  layer1_title=step.layer1_title
                  layer1_text=step.layer1_text
                  layer2button=step.layer2_button
                  layer2_title=step.layer2_title
                  layer2_text=step.layer2_text
                  viewer_warning=step.viewer_warning
                  is_last=forloop.last
                %}
              {% endunless %}
            {% endfor %}
          {% endif %}
        {% else %}
          {{ content }}
        {% endif %}
      </div>

      <!-- Story Navigation -->
      <div class="story-navigation" style="padding-bottom: 2rem;">
      </div>
    </div>

    <!-- Right Column: Fixed IIIF Viewer -->
    <div class="viewer-column {% unless show_story_steps %}hide-step-indicators{% endunless %}">
      {% include viewer.html %}
    </div>
  </main>

  <!-- Panels -->
  {% include panels.html %}

  <!-- Share Panel -->
  {% include share-panel.html %}

  <!-- Bootstrap 5 JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- UniversalViewer IIIF Viewer -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/universalviewer@4.0.0/dist/uv.css">
  <script src="https://cdn.jsdelivr.net/npm/universalviewer@4.0.0/dist/umd/UV.js"></script>

  <!-- Telar Core -->
  <script src="{{ '/assets/js/telar.js' | relative_url }}"></script>

  <!-- Story-specific JavaScript -->
  <script>
    // Pass story data to JavaScript
    {% if page.data_file %}
    {% assign data_file_name = page.data_file %}
    {% assign story_json = site.data[data_file_name] %}
    {% if story_json.encrypted %}
    // Story is encrypted - pass encrypted data
    window.storyData = {{ story_json | jsonify }};
    {% else %}
    // Story is not encrypted - pass steps normally
    {% assign first_step = story_json[0] %}
    {% if first_step._metadata %}
      {% assign first_step = story_json[1] %}
    {% endif %}
    window.storyData = {
      steps: {{ story_json | jsonify }},
      firstObject: "{{ first_step.object }}"
    };
    {% endif %}
    {% else %}
    window.storyData = {
      steps: {{ page.steps | jsonify }},
      firstObject: "{{ page.first_object }}"
    };
    {% endif %}

    // Pass objects data for manifest lookup
    window.objectsData = {{ site.data.objects | jsonify }};
  </script>
  {% if is_encrypted %}
  <!-- Bootstrap Icons for unlock overlay -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <script src="{{ '/assets/js/story-unlock.js' | relative_url }}"></script>
  {% endif %}
  <script src="{{ '/assets/js/telar-story.js' | relative_url }}"></script>
  <script src="{{ '/assets/js/widgets.js' | relative_url }}"></script>

  <!-- Share Panel JavaScript -->
  <script src="{{ '/assets/js/share-panel.js' | relative_url }}"></script>

  <!-- Story Unlock Overlay (for protected stories) - must be last for z-index -->
  {% if is_encrypted %}
  <div id="story-unlock-overlay" class="story-unlock-overlay d-none">
    <div class="unlock-content">
      <div class="unlock-icon">
        <!-- Minimalist keyhole -->
        <svg viewBox="0 0 48 72" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="24" cy="20" r="16" fill="#fff"/>
          <path d="M17 32L10 68H38L31 32H17Z" fill="#fff"/>
        </svg>
      </div>
      <h2 class="unlock-title">{{ lang.unlock.title | default: "This story is protected" }}</h2>
      <p class="unlock-description">{{ lang.unlock.description | default: "The author has restricted access to this story. Enter the key to continue." }}</p>
      <form id="unlock-form" class="unlock-form">
        <div class="input-group">
          <input type="password" id="unlock-key-input" placeholder="{{ lang.unlock.placeholder | default: 'Enter key' }}" autocomplete="off">
          <button type="button" id="toggle-key-visibility" aria-label="Toggle key visibility">
            <i class="bi bi-eye"></i>
          </button>
        </div>
        <div id="unlock-error" class="unlock-error d-none"></div>
        <button type="submit" class="unlock-button">{{ lang.unlock.button | default: "Unlock" }}</button>
      </form>
      <a href="{{ '/' | relative_url }}" class="unlock-back-link">{{ lang.unlock.back_link | default: "‚Üê Back to stories" }}</a>
    </div>
  </div>
  {% endif %}
</body>
</html>
