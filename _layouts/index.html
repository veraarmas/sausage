---
layout: default
title: Home
---

{% if site.telar_language and site.data.languages[site.telar_language] %}
  {% assign lang = site.data.languages[site.telar_language] %}
{% else %}
  {% assign lang = site.data.languages['en'] %}
{% endif %}

<div class="container my-5">
  <div class="row">
    <div class="col-lg-11 mx-auto">
      <h1 class="display-4 mb-3">{{ site.telar.project_title | default: site.title }}</h1>

      {% if site.telar.tagline %}
      <p class="lead mb-4">{{ site.telar.tagline }}</p>
      {% endif %}

    </div>
  </div>

  {% if site.description %}
  <div class="row">
    <div class="col-lg-11 mx-auto">
      <p class="lead site-description mb-4">{{ site.description }}</p>
    </div>
  </div>
  {% endif %}

  {%- comment -%}Validation warnings - all in one place{%- endcomment -%}
  <div class="row">
    <div class="col-lg-11 mx-auto">
      {% include iiif-url-warning.html %}
    </div>
  </div>

  <!-- Theme Validation -->
  {% assign has_theme_issue = false %}
  {% assign theme_error_type = "" %}
  {% assign configured_theme = site.data.themes[site.telar_theme] %}

  {% if configured_theme == nil or configured_theme == empty %}
    {% assign has_theme_issue = true %}

    {%- comment -%}Check if theme exists in _data/themes folder but failed to load{%- endcomment -%}
    {% assign all_theme_files = site.static_files | where_exp: "file", "file.path contains '_data/themes'" | where_exp: "file", "file.extname == '.yml'" %}
    {% assign theme_file_exists = false %}
    {% for file in all_theme_files %}
      {% if file.path contains site.telar_theme %}
        {% assign theme_file_exists = true %}
      {% endif %}
    {% endfor %}

    {% if theme_file_exists %}
      {% assign theme_error_type = "malformed" %}
    {% elsif site.data.themes['paisajes'] %}
      {% assign theme_error_type = "not_found" %}
    {% else %}
      {% assign theme_error_type = "critical" %}
    {% endif %}
  {% elsif configured_theme.colors == nil or configured_theme.fonts == nil %}
    {%- comment -%}Theme exists but missing required sections{%- endcomment -%}
    {% assign has_theme_issue = true %}
    {% assign theme_error_type = "malformed" %}
  {% endif %}

  <!-- Google Sheets Validation -->
  {% assign has_gs_issue = false %}
  {% assign gs_error_type = "" %}
  {% assign gs_error_details = "" %}

  {% if site.google_sheets.enabled %}
    {% assign shared_url = site.google_sheets.shared_url | strip %}
    {% assign published_url = site.google_sheets.published_url | strip %}

    {%- comment -%}Check if URLs are missing{%- endcomment -%}
    {% if shared_url == "" or published_url == "" %}
      {% assign has_gs_issue = true %}
      {% assign gs_error_type = "missing_urls" %}
    {% elsif shared_url == published_url %}
      {%- comment -%}Check if same URL used for both{%- endcomment -%}
      {% assign has_gs_issue = true %}
      {% assign gs_error_type = "same_url" %}
    {% else %}
      {%- comment -%}Check if URLs are swapped{%- endcomment -%}
      {% assign shared_has_de = shared_url | split: "/d/e/" | size %}
      {% assign published_has_edit = published_url | split: "/edit" | size %}
      {% assign published_has_de = published_url | split: "/d/e/" | size %}
      {% assign shared_has_d = shared_url | split: "/spreadsheets/d/" | size %}

      {% if shared_has_de > 1 %}
        {%- comment -%}Shared URL contains /d/e/ (published format){%- endcomment -%}
        {% assign has_gs_issue = true %}
        {% assign gs_error_type = "swapped_urls" %}
      {% elsif published_has_edit > 1 and published_has_de == 1 %}
        {%- comment -%}Published URL contains /edit but not /d/e/{%- endcomment -%}
        {% assign has_gs_issue = true %}
        {% assign gs_error_type = "swapped_urls" %}
      {% elsif shared_has_d == 1 %}
        {%- comment -%}Shared URL doesn't contain /spreadsheets/d/{%- endcomment -%}
        {% assign has_gs_issue = true %}
        {% assign gs_error_type = "malformed_shared" %}
      {% elsif published_has_de == 1 %}
        {%- comment -%}Published URL doesn't contain /d/e/{%- endcomment -%}
        {% assign has_gs_issue = true %}
        {% assign gs_error_type = "malformed_published" %}
      {% endif %}
    {% endif %}
  {% endif %}

  <!-- Configuration Issues Warning -->
  {% assign has_object_issues = false %}
  {% assign stories_with_issues = "" | split: "" %}

  {%- comment -%}Check for object warnings{%- endcomment -%}
  {% for object in site.objects %}
    {% if object.object_warning and object.object_warning != "" %}
      {% assign has_object_issues = true %}
      {% break %}
    {% endif %}
  {% endfor %}

  {%- comment -%}Collect stories with warnings{%- endcomment -%}
  {% for story in site.stories %}
    {% assign story_data = site.data[story.data_file] %}
    {% if story_data.size > 0 and story_data[0]._metadata %}
      {% assign metadata = story_data[0] %}
      {% if metadata.viewer_warnings.size > 0 %}
        {% assign stories_with_issues = stories_with_issues | push: story %}
      {% endif %}
    {% endif %}
  {% endfor %}

  {%- comment -%}Google Sheets Warnings{%- endcomment -%}
  {% if has_gs_issue %}
  <div class="row">
    <div class="col-lg-11 mx-auto">
      {% if gs_error_type == "missing_urls" %}
      <div class="alert alert-warning telar-alert" role="alert">
        <strong>⚠️ Your Google Sheets integration is incomplete</strong>
        <p class="mb-0 mt-2">
          Google Sheets integration is enabled but incomplete. You need to provide both a <code>shared_url</code> and a <code>published_url</code> in <code>_config.yml</code>. The shared URL comes from clicking the "Share" button in your Google Sheet. The published URL comes from File → Share → Publish to web (select "Entire document" and "Comma-separated values"). See the <a href="https://github.com/UCSB-AMPLab/telar/blob/main/docs/GOOGLE_SHEETS_TEMPLATE.md" class="alert-link" target="_blank">Google Sheets setup guide</a> for detailed instructions.
        </p>
      </div>
      {% elsif gs_error_type == "same_url" %}
      <div class="alert alert-warning telar-alert" role="alert">
        <strong>⚠️ Your Google Sheets URLs are identical</strong>
        <p class="mb-0 mt-2">
          You've used the same URL for both <code>shared_url</code> and <code>published_url</code> in <code>_config.yml</code>. These must be different URLs from the same Google Sheet. The shared URL comes from the "Share" button (ends with <code>/edit</code>). The published URL comes from File → Share → Publish to web (contains <code>/d/e/</code> and ends with <code>/pubhtml</code>).
        </p>
      </div>
      {% elsif gs_error_type == "swapped_urls" %}
      <div class="alert alert-warning telar-alert" role="alert">
        <strong>⚠️ Your Google Sheets URLs appear to be swapped</strong>
        <p class="mb-0 mt-2">
          Your Google Sheets URLs appear to be swapped in <code>_config.yml</code>. The <code>shared_url</code> should contain <code>/spreadsheets/d/{id}/edit</code> (from the Share button), but yours appears to be in published format. The <code>published_url</code> should contain <code>/d/e/{id}/pubhtml</code> (from Publish to web), but yours appears to be in shared format. Please swap these two URLs.
        </p>
      </div>
      {% elsif gs_error_type == "malformed_shared" %}
      <div class="alert alert-warning telar-alert" role="alert">
        <strong>⚠️ Your Google Sheets shared URL is incorrect</strong>
        <p class="mb-0 mt-2">
          Your Google Sheets <code>shared_url</code> in <code>_config.yml</code> doesn't match the expected format. It should look like: <code>https://docs.google.com/spreadsheets/d/{SHEET_ID}/edit</code>. Get this URL by clicking the "Share" button in your Google Sheet and copying the link.
        </p>
      </div>
      {% elsif gs_error_type == "malformed_published" %}
      <div class="alert alert-warning telar-alert" role="alert">
        <strong>⚠️ Your Google Sheets published URL is incorrect</strong>
        <p class="mb-0 mt-2">
          Your Google Sheets <code>published_url</code> in <code>_config.yml</code> doesn't match the expected format. It should look like: <code>https://docs.google.com/spreadsheets/d/e/{PUBLISHED_ID}/pubhtml</code>. Get this URL from File → Share → Publish to web. Make sure to select "Entire document" and "Comma-separated values (.csv)", then enable "Automatically republish when changes are made" before clicking Publish.
        </p>
      </div>
      {% endif %}
    </div>
  </div>
  {% endif %}

  {%- comment -%}Theme Warnings{%- endcomment -%}
  {% if has_theme_issue %}
  <div class="row">
    <div class="col-lg-11 mx-auto">
      {% if theme_error_type == "not_found" %}
      <div class="alert alert-warning telar-alert" role="alert">
        <strong>⚠️ Your selected theme doesn't exist</strong>
        <p class="mb-0 mt-2">
          The theme <code>{{ site.telar_theme }}</code> doesn't exist. We've applied the <code>paisajes</code> (default) theme instead. To choose a different theme, update <code>telar_theme</code> in <code>_config.yml</code> to one of: <code>paisajes</code>, <code>neogranadina</code>, <code>santa-barbara</code>, or <code>austin</code>. If you are trying to add a custom theme and you don't see it listed in this message, check it is in the <code>_data/themes</code> folder.
        </p>
      </div>
      {% elsif theme_error_type == "malformed" %}
      <div class="alert alert-warning telar-alert" role="alert">
        <strong>⚠️ Your theme file is broken</strong>
        <p class="mb-0 mt-2">
          The theme <code>{{ site.telar_theme }}</code> file appears to be broken or incomplete. We've applied a built-in fallback theme instead. Check <code>_data/themes/{{ site.telar_theme }}.yml</code> for syntax errors or compare it to a working theme file.
        </p>
      </div>
      {% elsif theme_error_type == "critical" %}
      <div class="alert alert-warning telar-alert" role="alert">
        <strong>⚠️ Theme system error detected</strong>
        <p class="mb-0 mt-2">
          We encountered a problem loading themes. The <code>_data/themes</code> folder may be missing or damaged. The site is currently using basic default styling. Please check that your <code>_data/themes</code> folder contains valid theme files, or restore it from your repository.
        </p>
      </div>
      {% endif %}
    </div>
  </div>
  {% endif %}

  {%- comment -%}Object Warnings{%- endcomment -%}
  {% if has_object_issues %}
  <div class="row">
    <div class="col-lg-11 mx-auto">
      <div class="alert alert-warning telar-alert" role="alert">
        <strong>⚠️ Object configuration issues detected</strong>
        <ul class="mt-2 mb-0">
          {% for object in site.objects %}
            {% if object.object_warning and object.object_warning != "" %}
              <li>
                <strong>{{ object.title | default: object.object_id }}</strong> ({{ object.object_id }}): {{ object.object_warning }}
              </li>
            {% endif %}
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>
  {% endif %}

  {%- comment -%}Story Warnings{%- endcomment -%}
  {% if stories_with_issues.size > 0 %}
  <div class="row">
    <div class="col-lg-11 mx-auto">
      <div class="alert alert-warning telar-alert" role="alert">
        <strong>⚠️ Story configuration issues detected</strong>
        <p class="mb-0 mt-2">
          {% assign second_to_last = stories_with_issues.size | minus: 1 %}
          Navigate to
          {% for story in stories_with_issues %}
            <a href="{{ story.url | relative_url }}" class="alert-link">{{ story.title }}</a>{% unless forloop.last %}{% if forloop.index == second_to_last %} or {% else %}, {% endif %}{% endunless %}
          {% endfor %} to see more details.
        </p>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Page Content -->
  {% if content and content != "" %}
  <div class="row mb-5">
    <div class="col-lg-11 mx-auto">
      <article class="page-content">
        {{ content }}
      </article>
    </div>
  </div>
  {% endif %}

  {%- comment -%}Check if stories/collections are hidden via development flags or interface settings{%- endcomment -%}
  {% assign dev_features = site['development-features'] %}
  {%- comment -%}Support both new names (skip_*) and legacy names (hide_*){%- endcomment -%}
  {% assign skip_stories = dev_features.skip_stories | default: dev_features.hide_stories | default: false %}
  {% assign skip_collections = dev_features.skip_collections | default: dev_features.hide_collections | default: false %}
  {% if skip_collections %}{% assign skip_stories = true %}{% endif %}

  {%- comment -%}Also check interface settings for homepage visibility{%- endcomment -%}
  {% assign story_show_on_homepage = site.story_interface.show_on_homepage | default: true %}
  {% assign collection_show_link = site.collection_interface.show_link_on_homepage | default: true %}

  <!-- Stories List (hidden when skip_stories enabled or show_on_homepage: false) -->
  {% unless skip_stories or story_show_on_homepage == false %}
  <div class="row">
    <div class="col-lg-11 mx-auto">
      <h2 class="mb-4">{{ page.stories_heading | default: "Explore the stories" }}</h2>
      {% if page.stories_intro and page.stories_intro != "" %}
      <p class="lead mb-4">{{ page.stories_intro }}</p>
      {% endif %}

      {% if site.stories.size > 0 %}
      {% assign sorted_stories = site.stories | sort: "sort_order" %}
      <div class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-5">
        {% for story in sorted_stories %}
        {%- comment -%}Load story data file and check if encrypted{%- endcomment -%}
        {% assign story_data = site.data[story.data_file] %}
        {% assign is_encrypted = false %}
        {% if story_data.encrypted %}
          {% assign is_encrypted = true %}
        {% endif %}
        <div class="col">
          <a href="{{ story.url | relative_url }}" class="story-card text-decoration-none">
            <div class="card h-100 border-0 shadow-sm{% if story.demo %} demo-story{% endif %}">
              {% if story.demo %}
              <span class="demo-badge">{{ lang.demo.badge }}</span>
              {% endif %}
              {% if is_encrypted %}
                {%- comment -%}Protected story — show keyhole instead of thumbnail{%- endcomment -%}
                <div class="story-protected-thumbnail d-flex align-items-center justify-content-center" style="aspect-ratio: 1;">
                  <svg viewBox="0 0 48 72" fill="none" xmlns="http://www.w3.org/2000/svg" class="protected-keyhole">
                    <circle cx="24" cy="20" r="16" fill="#fff"/>
                    <path d="M17 32L10 68H38L31 32H17Z" fill="#fff"/>
                  </svg>
                </div>
              {% elsif story_data and story_data.size > 0 %}
                {% assign first_step = story_data[0] %}
                {% if first_step.object %}
                  {%- comment -%}Load thumbnail with object ID for remote/local detection{%- endcomment -%}
                  <div class="story-iiif-thumbnail card-img-top" data-object-id="{{ first_step.object }}" data-info-json="{{ '/iiif/objects/' | append: first_step.object | append: '/info.json' | relative_url }}" style="aspect-ratio: 1; overflow: hidden;">
                    <div class="manifest-thumbnail-placeholder bg-light d-flex align-items-center justify-content-center h-100">
                      <span class="text-muted">Loading...</span>
                    </div>
                  </div>
                {% else %}
                  {%- comment -%}Fallback placeholder if no object{%- endcomment -%}
                  <div class="story-thumbnail-placeholder bg-secondary d-flex align-items-center justify-content-center" style="aspect-ratio: 1;">
                    <span class="text-white">{{ story.story_number }}</span>
                  </div>
                {% endif %}
              {% else %}
                {%- comment -%}Fallback placeholder if no data file{%- endcomment -%}
                <div class="story-thumbnail-placeholder bg-secondary d-flex align-items-center justify-content-center" style="aspect-ratio: 1;">
                  <span class="text-white">{{ story.story_number }}</span>
                </div>
              {% endif %}

              <div class="card-body">
                <h3>{{ story.title }}</h3>
                {% if is_encrypted %}
                <p class="story-card-byline">{{ lang.unlock.card_description | default: "This story is protected. You need a key to unlock it." }}</p>
                {% elsif story.byline %}
                <p class="story-card-byline">{{ story.byline | markdownify | strip_html | strip }}</p>
                {% endif %}
              </div>
            </div>
          </a>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div class="alert alert-info">
        <p class="mb-0">No stories available yet. Create story files in the <code>_stories/</code> directory to get started.</p>
      </div>
      {% endif %}
    </div>
  </div>
  {% endunless %}

  <!-- Objects Section (hidden when skip_collections enabled or show_link_on_homepage: false) -->
  {% unless skip_collections or collection_show_link == false %}
  {% if site.objects.size > 0 %}
  <div class="row mt-5">
    <div class="col-lg-11 mx-auto">
      <h3 class="mb-4">{{ page.objects_heading | default: "See the objects behind the stories" }}</h3>
      {% assign featured_objects = site.objects | where: "is_featured_sample", true %}
      {% assign show_featured = false %}
      {% if site.collection_interface.show_sample_on_homepage == true and featured_objects.size > 0 %}
        {% assign show_featured = true %}
      {% endif %}
      {% assign has_stories = false %}
      {% if site.stories.size > 0 %}{% assign has_stories = true %}{% endif %}
      {% if show_featured %}
        {% if featured_objects.size == site.objects.size %}
          {% if has_stories %}
            {% assign objects_text = lang.pages.objects_intro_all_stories | default: "There are {count} objects featured in the stories. Have a look at them below." %}
          {% else %}
            {% assign objects_text = lang.pages.objects_intro_all_collection | default: "There are {count} objects in the collection. Have a look at them below." %}
          {% endif %}
        {% else %}
          {% if has_stories %}
            {% assign objects_text = lang.pages.objects_intro_sample_stories | default: "There are {count} objects featured in the stories. Have a look at {sample} of them below." %}
          {% else %}
            {% assign objects_text = lang.pages.objects_intro_sample_collection | default: "There are {count} objects in the collection. Have a look at {sample} of them below." %}
          {% endif %}
          {% assign objects_text = objects_text | replace: "{sample}", featured_objects.size %}
        {% endif %}
      {% else %}
        {% if has_stories %}
          {% assign objects_text = lang.pages.objects_count | default: "Browse {count} objects featured in the stories." %}
        {% else %}
          {% assign objects_text = lang.pages.objects_count_collection | default: "Browse {count} objects in the collection." %}
        {% endif %}
      {% endif %}
      {% assign objects_text = objects_text | replace: "{count}", site.objects.size %}
      <p class="lead">{{ objects_text }}</p>

      <!-- Featured Objects Sample (shown when show_sample_on_homepage: true) -->
      {% if show_featured %}
      <h4 class="mt-4 mb-4">{{ lang.objects.featured_heading | default: "Featured objects" }}</h4>
      <div class="featured-objects-grid">
        {% for object in featured_objects %}
        <a href="{{ object.url | relative_url }}" class="collection-item">
          <div class="collection-thumbnail">
            {% if object.thumbnail and object.thumbnail != "" %}
              <img src="{{ object.thumbnail | relative_url }}" alt="{{ object.title }}" loading="lazy">
            {% else %}
              <div class="featured-iiif-thumbnail" data-object-id="{{ object.object_id }}" data-info-json="{{ '/iiif/objects/' | append: object.object_id | append: '/info.json' | relative_url }}">
                <span class="thumbnail-placeholder">{{ object.title | truncate: 15 }}</span>
              </div>
            {% endif %}
          </div>
          <div class="collection-info">
            <h4 class="collection-title">{{ object.title }}</h4>
            {% if object.period and object.period != "" %}
            <p class="collection-meta">{{ object.period }}</p>
            {% endif %}
            {% if object.creator and object.creator != "" %}
            <p class="collection-meta">{{ object.creator }}</p>
            {% endif %}
          </div>
        </a>
        {% endfor %}
      </div>
      {% endif %}

      <a href="{{ '/objects/' | relative_url }}" class="btn btn-primary mt-4">{{ lang.buttons.view_objects | default: "View all objects" }}</a>
    </div>
  </div>
  {% endif %}
  {% endunless %}
</div>

<script id="telar-stories-data" type="application/json">
[
  {% for story in site.stories %}
  {% assign story_data = site.data[story.data_file] %}
  {
    "title": {{ story.title | jsonify }},
    "url": "{{ story.url | absolute_url }}",
    "protected": {% if story_data.encrypted %}true{% else %}false{% endif %}
  }{% unless forloop.last %},{% endunless %}
  {% endfor %}
]
</script>

<script>
// Pass objects data for manifest lookup
window.objectsData = {{ site.data.objects | jsonify }};

/**
 * Load story thumbnails from IIIF (remote manifests or local info.json)
 */
document.addEventListener('DOMContentLoaded', function() {
  const storyThumbnails = document.querySelectorAll('.story-iiif-thumbnail[data-object-id]');

  storyThumbnails.forEach(function(item) {
    const objectId = item.getAttribute('data-object-id');
    const localInfoUrl = item.getAttribute('data-info-json');

    // Find object in objectsData
    const objectData = window.objectsData.find(obj => obj.object_id === objectId);

    // First check if object has explicit thumbnail URL (best for level0 IIIF, also works as override)
    if (objectData && objectData.thumbnail && objectData.thumbnail.trim() !== '') {
      const img = document.createElement('img');
      img.src = objectData.thumbnail;
      img.alt = item.closest('.story-card').querySelector('h3').textContent;
      img.style.width = '100%';
      img.style.height = '100%';
      img.style.objectFit = 'cover';

      const placeholder = item.querySelector('.manifest-thumbnail-placeholder');
      if (placeholder) {
        placeholder.replaceWith(img);
      }
    }
    // Check if object has remote IIIF manifest (for level2 servers that support dynamic sizing)
    else if (objectData && objectData.iiif_manifest) {
      // Remote manifest - fetch it and extract larger canvas image
      fetch(objectData.iiif_manifest)
        .then(response => response.json())
        .then(manifest => {
          let imageServiceUrl = null;
          let fallbackImageUrl = null;

          // IIIF Presentation API 2.1
          if (manifest.sequences && manifest.sequences[0] && manifest.sequences[0].canvases) {
            const firstCanvas = manifest.sequences[0].canvases[0];
            if (firstCanvas && firstCanvas.images && firstCanvas.images[0]) {
              const resource = firstCanvas.images[0].resource;

              // Try to get image service for resizing
              if (resource.service) {
                const service = Array.isArray(resource.service) ? resource.service[0] : resource.service;
                imageServiceUrl = service['@id'] || service.id;
              }

              // Fallback to full image URL
              if (!imageServiceUrl && resource['@id']) {
                fallbackImageUrl = resource['@id'];
              }
            }
          }
          // IIIF Presentation API 3.0
          else if (manifest.items && manifest.items[0]) {
            const firstCanvas = manifest.items[0];
            if (firstCanvas.items && firstCanvas.items[0] && firstCanvas.items[0].items) {
              const annotationBody = firstCanvas.items[0].items[0].body;

              // Try to get image service for resizing
              if (annotationBody.service && annotationBody.service.length > 0) {
                imageServiceUrl = annotationBody.service[0].id || annotationBody.service[0]['@id'];
              }

              // Fallback to full image URL
              if (!imageServiceUrl && annotationBody.id) {
                fallbackImageUrl = annotationBody.id;
              }
            }
          }

          let thumbnailUrl = null;

          // If we have an image service, request a 400px thumbnail
          if (imageServiceUrl) {
            // Remove trailing slash if present
            imageServiceUrl = imageServiceUrl.replace(/\/$/, '');
            thumbnailUrl = `${imageServiceUrl}/full/!400,400/0/default.jpg`;
          }
          // Otherwise use fallback image (will be scaled by CSS)
          else if (fallbackImageUrl) {
            thumbnailUrl = fallbackImageUrl;
          }

          if (thumbnailUrl) {
            const img = document.createElement('img');
            img.src = thumbnailUrl;
            img.alt = item.closest('.story-card').querySelector('h3').textContent;
            img.style.width = '100%';
            img.style.height = '100%';
            img.style.objectFit = 'cover';

            const placeholder = item.querySelector('.manifest-thumbnail-placeholder');
            if (placeholder) {
              placeholder.replaceWith(img);
            }
          } else {
            throw new Error('No image found in manifest');
          }
        })
        .catch(error => {
          console.error('Error loading remote IIIF manifest:', objectData.iiif_manifest, error);
          const placeholder = item.querySelector('.manifest-thumbnail-placeholder');
          if (placeholder) {
            placeholder.innerHTML = '<span class="text-danger">Failed to load</span>';
          }
        });
    } else {
      // Local IIIF info.json
      fetch(localInfoUrl)
        .then(response => response.json())
        .then(info => {
          const sizes = info.sizes || [];
          let thumbnailSize = sizes[0];

          if (thumbnailSize) {
            const baseUrl = info.id || info['@id'];
            const thumbnailUrl = `${baseUrl}/full/${thumbnailSize.width},/0/default.jpg`;

            const img = document.createElement('img');
            img.src = thumbnailUrl;
            img.alt = item.closest('.story-card').querySelector('h3').textContent;
            img.style.width = '100%';
            img.style.height = '100%';
            img.style.objectFit = 'cover';

            const placeholder = item.querySelector('.manifest-thumbnail-placeholder');
            if (placeholder) {
              placeholder.replaceWith(img);
            }
          }
        })
        .catch(error => {
          console.error('Error loading local IIIF info.json:', localInfoUrl, error);
          const placeholder = item.querySelector('.manifest-thumbnail-placeholder');
          if (placeholder) {
            placeholder.innerHTML = '<span class="text-danger">Failed to load</span>';
          }
        });
    }
  });
});

/**
 * Load featured object thumbnails from local IIIF tiles
 */
const featuredThumbnails = document.querySelectorAll('.featured-iiif-thumbnail[data-object-id]');
featuredThumbnails.forEach(function(item) {
  const objectId = item.getAttribute('data-object-id');
  const localInfoUrl = item.getAttribute('data-info-json');

  // Find object in objectsData for potential remote manifest
  const objectData = window.objectsData.find(obj => obj.object_id === objectId);

  // Check for explicit thumbnail first
  if (objectData && objectData.thumbnail && objectData.thumbnail.trim() !== '') {
    const img = document.createElement('img');
    img.src = objectData.thumbnail;
    img.alt = item.closest('.collection-item').querySelector('.collection-title').textContent;
    img.style.width = '100%';
    img.style.height = '100%';
    img.style.objectFit = 'cover';
    item.innerHTML = '';
    item.appendChild(img);
  }
  // Check for remote IIIF manifest
  else if (objectData && objectData.iiif_manifest) {
    fetch(objectData.iiif_manifest)
      .then(response => response.json())
      .then(manifest => {
        let imageServiceUrl = null;
        let fallbackImageUrl = null;

        // IIIF Presentation API 2.1
        if (manifest.sequences && manifest.sequences[0] && manifest.sequences[0].canvases) {
          const firstCanvas = manifest.sequences[0].canvases[0];
          if (firstCanvas && firstCanvas.images && firstCanvas.images[0]) {
            const resource = firstCanvas.images[0].resource;
            if (resource.service) {
              const service = Array.isArray(resource.service) ? resource.service[0] : resource.service;
              imageServiceUrl = service['@id'] || service.id;
            }
            if (!imageServiceUrl && resource['@id']) {
              fallbackImageUrl = resource['@id'];
            }
          }
        }
        // IIIF Presentation API 3.0
        else if (manifest.items && manifest.items[0]) {
          const firstCanvas = manifest.items[0];
          if (firstCanvas.items && firstCanvas.items[0] && firstCanvas.items[0].items) {
            const annotationBody = firstCanvas.items[0].items[0].body;
            if (annotationBody.service && annotationBody.service.length > 0) {
              imageServiceUrl = annotationBody.service[0].id || annotationBody.service[0]['@id'];
            }
            if (!imageServiceUrl && annotationBody.id) {
              fallbackImageUrl = annotationBody.id;
            }
          }
        }

        let thumbnailUrl = null;
        if (imageServiceUrl) {
          imageServiceUrl = imageServiceUrl.replace(/\/$/, '');
          thumbnailUrl = `${imageServiceUrl}/full/!200,200/0/default.jpg`;
        } else if (fallbackImageUrl) {
          thumbnailUrl = fallbackImageUrl;
        }

        if (thumbnailUrl) {
          const img = document.createElement('img');
          img.src = thumbnailUrl;
          img.alt = item.closest('.collection-item').querySelector('.collection-title').textContent;
          img.style.width = '100%';
          img.style.height = '100%';
          img.style.objectFit = 'cover';
          item.innerHTML = '';
          item.appendChild(img);
        }
      })
      .catch(error => {
        console.error('Error loading featured object manifest:', objectData.iiif_manifest, error);
      });
  }
  // Local IIIF info.json
  else {
    fetch(localInfoUrl)
      .then(response => response.json())
      .then(info => {
        const sizes = info.sizes || [];
        let thumbnailSize = sizes[0];

        if (thumbnailSize) {
          const baseUrl = info.id || info['@id'];
          const thumbnailUrl = `${baseUrl}/full/${thumbnailSize.width},/0/default.jpg`;

          const img = document.createElement('img');
          img.src = thumbnailUrl;
          img.alt = item.closest('.collection-item').querySelector('.collection-title').textContent;
          img.style.width = '100%';
          img.style.height = '100%';
          img.style.objectFit = 'cover';
          item.innerHTML = '';
          item.appendChild(img);
        }
      })
      .catch(error => {
        console.error('Error loading featured object info.json:', localInfoUrl, error);
      });
  }
});

/**
 * Prefetch story manifests on hover (v0.6.2)
 * When user hovers over a story card, prefetch its IIIF manifests
 * to reduce loading time when they enter the story.
 */
document.querySelectorAll('.story-card').forEach(function(card) {
  card.addEventListener('mouseenter', function() {
    // Find all objects used in this story by looking at its data
    const storyUrl = this.getAttribute('href');
    if (!storyUrl) return;

    // Get the story's first object from the thumbnail element
    const thumbnailEl = this.querySelector('.story-iiif-thumbnail[data-object-id]');
    if (!thumbnailEl) return;

    const objectId = thumbnailEl.getAttribute('data-object-id');
    if (!objectId) return;

    // Find object data and prefetch its manifest
    const objectData = window.objectsData.find(obj => obj.object_id === objectId);
    if (objectData && objectData.iiif_manifest) {
      // Create prefetch link if not already prefetched
      const existingPrefetch = document.querySelector(`link[href="${objectData.iiif_manifest}"]`);
      if (!existingPrefetch) {
        const prefetchLink = document.createElement('link');
        prefetchLink.rel = 'prefetch';
        prefetchLink.href = objectData.iiif_manifest;
        document.head.appendChild(prefetchLink);
        console.log(`Prefetching manifest for ${objectId} on hover`);
      }
    }
  }, { once: true }); // Only prefetch once per story card
});
</script>
