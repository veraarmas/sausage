name: Upgrade Telar
#
# When a new version of Telar is released, site owners use this workflow to
# upgrade their site. It is triggered manually from the Actions tab in GitHub
# — the user clicks "Run workflow" and the rest is automatic.
#
# The workflow works by fetching the latest scripts from the main Telar
# repository (UCSB-AMPLab/telar), then running upgrade.py — the migration
# script that applies version-to-version changes. Each migration step knows
# how to transform a site from one version to the next: adding new files,
# updating configuration, modifying templates, and so on. The script walks
# the chain from the site's current version to the latest, applying each
# migration in sequence.
#
# Rather than modifying the site's main branch directly, the workflow creates
# a separate upgrade branch with all the changes, then opens a GitHub issue
# with a clear summary of what changed and a link to review and merge. This
# gives the site owner a chance to inspect the changes before they go live.
# The issue also lists any manual steps that need to be completed after
# merging (for example, updating custom content that the script cannot
# migrate automatically).
#
# Version: v0.7.0-beta

on:
  workflow_dispatch:
    inputs:
      create_pr:
        description: 'Create pull request with changes'
        type: boolean
        default: true

permissions:
  contents: write
  issues: write

jobs:
  upgrade:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Fetch all history for proper git operations

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install pyyaml pandas

      - name: Fetch latest upgrade scripts
        run: |
          echo "Fetching latest upgrade scripts from telar repository..."
          # Remove old scripts if they exist
          rm -rf scripts/
          # Fetch latest scripts from telar repo
          curl -L https://github.com/UCSB-AMPLab/telar/archive/refs/heads/main.tar.gz | tar xz --strip-components=1 telar-main/scripts
          echo "✓ Latest upgrade scripts fetched"

      - name: Check current version and language
        id: check_version
        run: |
          CURRENT_VERSION=$(python3 -c "import yaml; config=yaml.safe_load(open('_config.yml')); print(config.get('telar', {}).get('version', '0.2.0-beta'))")
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $CURRENT_VERSION"

          SITE_LANG=$(python3 -c "import yaml; config=yaml.safe_load(open('_config.yml')); print(config.get('telar_language', 'en'))")
          echo "site_language=$SITE_LANG" >> $GITHUB_OUTPUT
          echo "Site language: $SITE_LANG"

      - name: Run upgrade script
        id: upgrade
        run: |
          python scripts/upgrade.py

          if [ -f UPGRADE_VERSION.txt ]; then
            VERSION=$(cat UPGRADE_VERSION.txt)
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "Upgraded to version: $VERSION"
          else
            echo "No upgrade needed or upgrade failed"
            exit 1
          fi

      # NOTE: Version update is handled by upgrade.py using text-based editing
      # to preserve comments in _config.yml. Do NOT use yaml.dump() here as
      # it strips all comments!

      - name: Create upgrade branch
        if: steps.upgrade.outputs.version != ''
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          BRANCH_NAME="upgrade-telar-${{ steps.upgrade.outputs.version }}"

          # Delete remote branch if it exists
          git push origin --delete "$BRANCH_NAME" 2>/dev/null || true

          git checkout -b "$BRANCH_NAME"
          git add .
          git commit -m "Upgrade Telar from ${{ steps.check_version.outputs.current_version }} to ${{ steps.upgrade.outputs.version }}"
          git push origin "$BRANCH_NAME"

          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
        id: create_branch

      - name: Create upgrade issue
        if: steps.upgrade.outputs.version != ''
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Get repository info
          REPO="${{ github.repository }}"
          BRANCH="${{ steps.create_branch.outputs.branch_name }}"
          VERSION="${{ steps.upgrade.outputs.version }}"
          FROM_VERSION="${{ steps.check_version.outputs.current_version }}"
          SITE_LANG="${{ steps.check_version.outputs.site_language }}"
          COMPARE_URL="https://github.com/$REPO/compare/main...$BRANCH"

          # Strip YAML frontmatter from UPGRADE_SUMMARY.md (remove everything between first --- and second ---)
          SUMMARY_CONTENT=$(sed '/^---$/,/^---$/d' UPGRADE_SUMMARY.md)

          # Extract automated changes and manual steps counts from the summary
          AUTOMATED_CHANGES=$(grep -o '\*\*Automated changes:\*\* [0-9]\+' UPGRADE_SUMMARY.md | sed 's/.*\*\* \([0-9]\+\)/\1/')
          MANUAL_STEPS=$(grep -o '\*\*Manual steps:\*\* [0-9]\+' UPGRADE_SUMMARY.md | sed 's/.*\*\* \([0-9]\+\)/\1/')

          # Extract manual steps from UPGRADE_SUMMARY.md (if any)
          MANUAL_STEPS_TEXT=$(sed -n '/## Manual Steps Required/,/## Resources/p' UPGRADE_SUMMARY.md | sed '1d;$d' | sed '/^Please complete these after merging:/d' | sed '/^$/d')

          # Set language-specific strings
          if [ "$SITE_LANG" = "es" ]; then
            TITLE="Actualizar Telar a $VERSION"
            HEADER="## Actualizacion lista: v$FROM_VERSION → v$VERSION"
            STATUS="**Estado:** Actualizacion automatica completada"
            BRANCH_LABEL="**Rama:**"
            CHANGES_LABEL="**Cambios:** $AUTOMATED_CHANGES automaticos, $MANUAL_STEPS manuales"
            NEXT_STEP="## Siguiente paso: Revisar y fusionar"
            INTRO="Tu sitio Telar ha sido actualizado exitosamente y esta listo para fusionar."
            CTA="### **[Haz clic aqui para revisar los cambios y crear pull request]($COMPARE_URL)**"
            CTA_FOLLOW="Luego haz clic en el boton verde \"Create pull request\", revisa los cambios y fusiona para completar la actualizacion."
            CLI_SUMMARY="<b>Para usuarios que prefieren la linea de comandos</b> (clic para expandir)"
            CLI_INTRO="Si prefieres trabajar desde tu terminal:"
            CLI_NOTE="Esto fusionara la rama de actualizacion en tu rama principal. Recomendamos usar el metodo de pull request de arriba, ya que proporciona una mejor interfaz de revision."
            AFTER_MERGE="## Despues de fusionar"
            AFTER_INTRO="Una vez que hayas fusionado la actualizacion, por favor completa lo siguiente:"
            MANUAL_HEADER="### Pasos manuales"
            VERIFY_HEADER="### Verifica tu sitio"
            VERIFY_STEPS="Despues de que la actualizacion se complete y tu sitio se reconstruya:

          1. Visita tu sitio en vivo y navega por algunas paginas
          2. Busca mensajes de advertencia o alertas sobre problemas de configuracion
          3. Si ves advertencias, sigue los enlaces o documentacion proporcionada para resolverlas
          4. Prueba las funciones clave como navegacion de historias, visualizacion de imagenes y terminos del glosario
          5. **Cierra este issue** una vez que todo este funcionando - esto marca la actualizacion como completa"
            WHAT_CHANGED="## Que cambio"
            CHANGES_SUMMARY="<b>Ver cambios automaticos por categoria</b> (clic para expandir)"
            FOOTER="<sub>Esta actualizacion fue realizada automaticamente por el workflow de actualizacion de Telar.</sub>"
          else
            TITLE="Upgrade Telar to $VERSION"
            HEADER="## Upgrade Ready: v$FROM_VERSION → v$VERSION"
            STATUS="**Status:** Automated upgrade complete"
            BRANCH_LABEL="**Branch:**"
            CHANGES_LABEL="**Changes:** $AUTOMATED_CHANGES automated, $MANUAL_STEPS manual"
            NEXT_STEP="## Next Step: Review and Merge"
            INTRO="Your Telar site has been successfully upgraded and is ready to merge."
            CTA="### **[Click here to review changes and create pull request]($COMPARE_URL)**"
            CTA_FOLLOW="Then click the green \"Create pull request\" button, review the changes, and merge to complete the upgrade."
            CLI_SUMMARY="<b>For users who prefer the command line</b> (click to expand)"
            CLI_INTRO="If you prefer working from your terminal:"
            CLI_NOTE="This will merge the upgrade branch into your main branch. We recommend using the pull request method above instead, as it provides a better review interface."
            AFTER_MERGE="## After Merging"
            AFTER_INTRO="Once you've merged the upgrade, please complete the following:"
            MANUAL_HEADER="### Manual Steps"
            VERIFY_HEADER="### Verify Your Site"
            VERIFY_STEPS="After the upgrade completes and your site rebuilds:

          1. Visit your live site and navigate through a few pages
          2. Check for any warning messages or alerts about configuration issues
          3. If you see any warnings, follow the links or documentation provided to resolve them
          4. Test key features like story navigation, image viewing, and glossary terms
          5. **Close this issue** once everything is working - this marks the upgrade as complete"
            WHAT_CHANGED="## What Changed"
            CHANGES_SUMMARY="<b>View automated changes by category</b> (click to expand)"
            FOOTER="<sub>This upgrade was performed automatically by the Telar upgrade workflow.</sub>"
          fi

          # Create issue body
          cat > issue_body.md << EOF
          $HEADER

          $STATUS
          $BRANCH_LABEL \`$BRANCH\`
          $CHANGES_LABEL

          ---

          $NEXT_STEP

          $INTRO

          $CTA

          $CTA_FOLLOW

          <details>
          <summary>$CLI_SUMMARY</summary>

          $CLI_INTRO

          \`\`\`bash
          git fetch origin
          git checkout main
          git merge origin/$BRANCH
          git push origin main
          \`\`\`

          $CLI_NOTE

          </details>

          ---

          $AFTER_MERGE

          $AFTER_INTRO

          EOF

          # Add manual steps section only if there are manual steps
          if [ "$MANUAL_STEPS" != "0" ] && [ -n "$MANUAL_STEPS_TEXT" ]; then
            cat >> issue_body.md << EOF
          $MANUAL_HEADER

          $MANUAL_STEPS_TEXT

          EOF
          fi

          # Always add verify section
          cat >> issue_body.md << EOF
          $VERIFY_HEADER

          $VERIFY_STEPS

          ---

          $WHAT_CHANGED

          <details>
          <summary>$CHANGES_SUMMARY</summary>

          $SUMMARY_CONTENT

          </details>

          ---

          $FOOTER
          EOF

          # Create upgrade label if it doesn't exist
          gh label create "upgrade" --description "Automated Telar upgrade" --color "0E8A16" 2>/dev/null || true

          # Create the issue
          gh issue create \
            --title "$TITLE" \
            --body-file issue_body.md \
            --label "upgrade"

      - name: Output summary
        if: steps.upgrade.outputs.version != ''
        run: |
          echo "## ✅ Upgrade Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **From:** ${{ steps.check_version.outputs.current_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **To:** ${{ steps.upgrade.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** \`${{ steps.create_branch.outputs.branch_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "An issue has been created with upgrade details and merge instructions." >> $GITHUB_STEP_SUMMARY
          echo "Check the **Issues** tab to review and apply the upgrade." >> $GITHUB_STEP_SUMMARY
